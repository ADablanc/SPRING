testthat::test_that("db connect", {
    db <- db_connect(":memory:")
    testthat::expect_s4_class(
        db,
        "SQLiteConnection"
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db write table", {
    db <- db_connect(":memory:")
    db_write_table(db, "mtcars", mtcars, row.names = TRUE)
    testthat::expect_identical(
        RSQLite::dbReadTable(db, "mtcars", row.names = TRUE),
        mtcars
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db execute", {
    db <- db_connect(":memory:")
    db_write_table(db, "mtcars", mtcars, row.names = TRUE)
    testthat::expect_error(
        db_execute(
            db,
            "INSERT INTO mtcars
                  (mpg, cyl, disp, hp, drat, wt, qsec, vs, am, gear, carb)
            VALUES (0, 0, 0, 0, 0, 0, 0, 0, 0, 0);"
        ),
        "10 values for 11 columns"
    )
    db_execute(
        db,
        "INSERT INTO mtcars
                  (mpg, cyl, disp, hp, drat, wt, qsec, vs, am, gear, carb)
            VALUES (0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);"
    )
    testthat::expect_equal(
        RSQLite::dbGetQuery(db, "SELECT COUNT(*) FROM mtcars")[1, 1],
        nrow(mtcars) + 1
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db get query", {
    db <- db_connect(":memory:")
    db_write_table(db, "mtcars", mtcars, row.names = TRUE)
    testthat::expect_error(
        db_get_query(db, "SELECT id FROM mtcars"),
        "no such column: id"
    )
    testthat::expect_identical(
        db_get_query(db, "SELECT * FROM peaks"),
        data.frame()
    )
    testthat::expect_identical(
        db_get_query(db, "SELECT * FROM mtcars", row.names = TRUE),
        mtcars
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db read table", {
    db <- db_connect(":memory:")
    db_write_table(db, "mtcars", mtcars, row.names = TRUE)
    testthat::expect_identical(
        db_read_table(db, "peaks"),
        data.frame()
    )
    testthat::expect_identical(
        db_read_table(db, "mtcars", row.names = TRUE),
        mtcars
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db record ann", {
    xsf <- list(
        ann = data.frame(
            pcgroup_id = c(1, 2, 3, 3, 3, 3, 3, 3, 4, 4, 5, 6, 7, 8),
            basepeak_group_id = c(4, 5, 1, 1, 2, 2, 12, 12, 13, 14, 6, 7, 15,
                                  11),
            formula = c(NA, NA, "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                        "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                        "C30H59N1O3", "C30H59N1O3", NA, NA, NA, NA),
            class = c(NA, NA, "LPC", "LPC", "LPC", "LPC", "LPC", "LPC", "Cer",
                      "Cer", NA, NA, NA, NA),
            name = c(NA, NA, "LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0",
                     "LPC 11:0", "LPC 11a:0", "Cer (d18:1/C12:0)",
                     "Cer (d18:1/C12:0)", NA, NA, NA, NA),
            referent_adduct = c(NA, NA, "[M+H]+", "[M+H]+", "[M+H]+", "[M+H]+",
                             "[M+H]+", "[M+H]+", "[M+H-H2O]+", "[M+H-H2O]+", NA,
                             NA, NA, NA),
            adduct = c(NA, NA, "[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+",
                       "[M+Na]+", "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", NA, NA,
                       NA, NA),
            ion_formula = c(NA, NA, "C19H39N1O6P1", "C19H39N1O6P1",
                            "C19H41N1O7P1", "C19H41N1O7P1", "C19H40N1O7P1Na1",
                            "C19H40N1O7P1Na1", "C30H58N1O2", "C30H59N1O3Na1",
                            NA, NA, NA, NA),
            rtdiff = c(NA, NA, 8.99149999999997, 4.19150000000002,
                       8.99149999999997, 4.19150000000002, 8.99149999999997,
                       4.19150000000002, 2.37300000000002, 2.37300000000002, NA,
                       NA, NA, NA),
            rt = c(279.141, 259.046, 286.8085, 286.8085, 286.8085, 286.8085,
                   286.8085, 286.8085, 197.973, 197.973, 297.915, 308.494,
                   197.444, 306.904),
            rtmin = c(291.037, 264.598, 287.864, 287.864, 293.152, 293.152,
                      292.095, 292.095, 199.559, 208.548, 303.202, 310.081,
                      201.145, 309.549),
            rtmax = c(279.407, 259.31, 286.81, 286.81, 286.81, 286.81, 286.81,
                      286.81, 197.973, 197.973, 297.915, 308.494, 197.444,
                      306.904),
            nsamples = c(2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0),
            best_score = c(0, 0, 79.8211975097656, 79.8211975097656,
                           95.0912628173828, 95.0912628173828, 79.6432037353516,
                           79.6432037353516, 71.3979721069336, 71.1946487426758,
                           0, 0, 0, 0),
            best_deviation_mz = c(Inf, Inf, .0003662109375, .0003662109375,
                                  .00048828125, .00048828125, .00018310546875,
                                  .00018310546875, .0010986328125,
                                  .001312255859375, Inf, Inf, Inf, Inf),
            best_npeak = c(0, 0, 1, 1, 2, 2, 1, 1, 1, 1, 0, 0, 0, 0),
            `220221CCM_global_POS_01_ssleu_filtered` = c(1, 3, NA, NA, 6, 6, 8,
                                                         8, 10, 12, 14, 15, 16,
                                                         NA),
            `220221CCM_global_POS_02_ssleu_filtered` = c(2, 4, 5, 5, 7, 7, 9, 9,
                                                         11, 13, NA, NA, 17,
                                                         18),
            check.names = FALSE
        ),
        spectra_infos = data.frame(
            spectra_id =  c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
                            16, 17, 18),
            score = c(0, 0, 0, 0, 79.8211975097656, 95.0912628173828,
                      95.0683822631836, 79.6432037353516, 79.6432037353516,
                      71.3979721069336, 71.3979721069336, 71.1946487426758,
                      71.1946487426758, 0, 0, 0, 0, 0),
            deviation_mz = c(NaN, NaN, NaN, NaN, .0003662109375, .00048828125,
                             .0008392333984375, .00018310546875,
                             .000701904296875, .0010986328125, .001251220703125,
                             .001312255859375, .00177001953125, NaN, NaN, NaN,
                             NaN, NaN),
            npeak = c(0, 0, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0),
            basepeak_mz = c(428.267772595199, 428.268471709284,
                            428.267855601901, 428.268539638095,
                            408.251325886322, 426.261908233279,
                            426.262343531217, 448.243644005027,
                            448.244163142448, 464.447304014051,
                            464.447454557257, 504.440032161331, 504.44048100644,
                            428.2675574767, 428.267840674347, 505.443534603,
                            505.44383474773, 429.270782294993),
            basepeak_int = c(21634957.3317308, 19992518.2568646,
                             7556081.77126924, 7375409.9176154, 88824.635233072,
                             6139220.0505469, 6234084.85605467,
                             260064.992761365, 288524.169413714,
                             4945601.93026269, 5689144.27927454,
                             1287181.56877954, 1458245.19191226,
                             2235868.3566111, 753309.518850004,
                             401071.227087501, 444013.097852865,
                             323001.699462891),
            sum_int = c(0, 0, 0, 0, 88824.635233072, 7309860.00925784,
                        7420749.7462611, 260064.992761365, 288524.169413714,
                        4945601.93026269, 5689144.27927454, 1287181.56877954,
                        1458245.19191226, 0, 0, 0, 0, 0),
            sample = c("220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_01_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered",
                       "220221CCM_global_POS_02_ssleu_filtered"),
            rt  = c(279.407, 278.875, 258.782, 259.31, 286.278, 286.81, 286.807,
                    286.81, 286.807, 197.973, 197.973, 197.444, 197.973,
                    297.915, 308.494, 197.444, 197.444, 306.904)
        ),
        spectras = data.frame(
            spectra_id = c(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7,
                           7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, 11,
                           11, 11, 12, 12, 12, 12, 13, 13, 13, 13, 14, 14, 15,
                           16, 17, 18),
            feature_id = c(7, 9, 22, 24, 8, 10, 23, 17, 18, NA, NA, NA, 6, 4,
                           NA, NA, 21, 20, NA, NA, 5, NA, NA, NA, 19, NA, NA,
                           NA, 1, NA, NA, NA, 15, NA, NA, NA, 2, NA, NA, NA, 16,
                           NA, NA, NA, 12, 11, 13, 3, 14, 25),
            mz = c(428.267772595199, 429.270423563444, 428.268471709284,
                   429.271192885151, 428.267855601901, 429.270339913969,
                   428.268539638095, 429.270885645465, 408.251325886321, NA, NA,
                   NA, 426.261908233279, 427.265397484755, NA, NA,
                   426.262343531217, 427.265671264404, NA, NA, 448.243644005027,
                   NA, NA, NA, 448.244163142448, NA, NA, NA, 464.447304014051,
                   NA, NA, NA, 464.447454557257, NA, NA, NA, 504.440032161331,
                   NA, NA, NA, 504.44048100644, NA, NA, NA, 428.2675574767,
                   429.269607476748, 428.267840674347, 505.443534603,
                   505.44383474773, 429.270782294993),
            mzmin = c(428.267364501953, 429.269836425781, 428.268035888672,
                      429.270721435547, 428.267425537109, 429.269653320312,
                      428.267822265625, 429.270324707031, 408.251037597656, NA,
                      NA, NA, 426.261444091797, 427.264739990234, NA, NA,
                      426.262023925781, 427.264801025391, NA, NA,
                      448.243011474609, NA, NA, NA, 448.242279052734, NA, NA,
                      NA, 464.447021484375, NA, NA, NA, 464.446746826172, NA,
                      NA, NA, 504.439697265625, NA, NA, NA, 504.439544677734,
                      NA, NA, NA, 428.267242431641, 429.269256591797,
                      428.267364501953, 505.443084716797, 505.440704345703,
                      429.270416259766),
            mzmax = c(428.268310546875, 429.271362304688, 428.269195556641,
                      429.271636962891, 428.268615722656, 429.270904541016,
                      428.269287109375, 429.271575927734, 408.25146484375, NA,
                      NA, NA, 426.262420654297, 427.266052246094, NA, NA,
                      426.262786865234, 427.266052246094, NA, NA,
                      448.245391845703, NA, NA, NA, 448.245422363281, NA, NA,
                      NA, 464.447662353516, NA, NA, NA, 464.447967529297, NA,
                      NA, NA, 504.440490722656, NA, NA, NA, 504.441101074219,
                      NA, NA, NA, 428.268035888672, 429.269958496094,
                      428.2685546875, 505.443664550781, 505.444122314453,
                      429.271636962891),
            rt = c(279.407, 279.407, 278.875, 278.875, 258.782, 258.782, 259.31,
                   258.782, 286.278, NA, NA, NA, 286.81, 286.81, NA, NA,
                   286.807, 286.807, NA, NA, 286.81, NA, NA, NA, 286.807, NA,
                   NA, NA, 197.973, NA, NA, NA, 197.973, NA, NA, NA, 197.444,
                   NA, NA, NA, 197.973, NA, NA, NA, 297.915, 296.857, 308.494,
                   197.444, 197.444, 306.904),
            rtmin = c(265.656, 265.656, 265.656, 265.127, 250.85, 250.85,
                      250.85, 250.85, 284.692, NA, NA, NA, 284.695, 284.695, NA,
                      NA, 284.692, 283.105, NA, NA, 285.224, NA, NA, NA, 280.99,
                      NA, NA, NA, 196.386, NA, NA, NA, 195.858, NA, NA, NA,
                      193.743, NA, NA, NA, 182.11, NA, NA, NA, 293.684, 295.271,
                      304.789, 196.386, 196.387, 301.084),
            rtmax = c(293.156, 294.742, 291.037, 291.037, 264.598, 264.598,
                      264.598, 264.069, 287.864, NA, NA, NA, 291.04, 291.04, NA,
                      NA, 293.152, 292.623, NA, NA, 291.04, NA, NA, NA, 292.095,
                      NA, NA, NA, 200.617, NA, NA, NA, 199.559, NA, NA, NA,
                      199.03, NA, NA, NA, 208.548, NA, NA, NA, 303.202, 307.966,
                      310.081, 199.03, 201.145, 309.549),
            int = c(21634957.3317308, 5360632.29847273, 19992518.2568646,
                    4939357.04715561, 7556081.77126924, 1854836.50349039,
                    7375409.9176154, 1621835.871345, 88824.635233072, NA, NA,
                    NA, 6139220.0505469, 1170639.95871094, NA, NA,
                    6234084.85605467, 1186664.89020643, NA, NA,
                    260064.992761365, NA, NA, NA, 288524.169413714, NA, NA, NA,
                    4945601.93026269, NA, NA, NA, 5689144.27927454, NA, NA, NA,
                    1287181.56877954, NA, NA, NA, 1458245.19191226, NA, NA, NA,
                    2235868.3566111, 450077.636764323, 753309.518850004,
                    401071.227087501, 444013.097852865, 323001.699462891),
            abd = c(100, 24.7776421107639, 100, 24.7060274433394, 100,
                    24.5475970170559, 100, 21.9897726290631, 100, NA, NA, NA,
                    100, 19.0682195632759, NA, NA, 100, 19.0351096850072, NA,
                    NA, 100, NA, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA, 100,
                    NA, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA, 100,
                    20.1298808775354, 100, 100, 100, 100),
            mz_theo = c(NA, NA, NA, NA, NA, NA, NA, NA, 408.25095, 409.25427,
                        410.25672, 411.25935, 426.26152, 427.26484, 428.26719,
                        429.26984, 426.26152, 427.26484, 428.26719, 429.26984,
                        448.24346, 449.24678, 450.24914, 451.25178, 448.24346,
                        449.24678, 450.24914, 451.25178, 464.44621, 465.44955,
                        466.45272, 467.45576, 464.44621, 465.44955, 466.45272,
                        467.45576, 504.43872, 505.44206, 506.44516, 507.44809,
                        504.43872, 505.44206, 506.44516, 507.44809, NA, NA, NA,
                        NA, NA, NA),
            abd_theo = c(NA, NA, NA, NA, NA, NA, NA, NA, 100, 21.65, 3.25, 0.38,
                         100, 21.7, 3.46, 0.42, 100, 21.7, 3.46, 0.42, 100,
                         21.69, 3.45, 0.42, 100, 21.69, 3.45, 0.42, 100, 33.55,
                         5.86, 0.65, 100, 33.55, 5.86, 0.65, 100, 33.67, 6.07,
                         0.72, 100, 33.67, 6.07, 0.72, NA, NA, NA, NA, NA, NA),
            iso_theo = c(NA, NA, NA, NA, NA, NA, NA, NA, "M", "M+1", "M+2",
                         "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2",
                         "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2",
                         "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2",
                         "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2",
                         "M+3", NA, NA, NA, NA, NA, NA)
        ),
        peakgroups = data.frame(
            group_id = 1:15,
            pcgroup_id = c(3, 3, 3, 1, 2, 5, 6, 2, 1, 5, 8, 3, 4, 4, 7),
            adduct = c("[M+H-H2O]+", "[M+H]+", NA, NA, NA, NA, NA, NA, NA, NA,
                       NA, "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", NA),
            cluster_id = c(1, 2, 2, 4, 5, 6, 7, 5, 4, 6, 11, 12, 13, 14, 15),
            iso = c("M", "M", "M+*", "M", "M", "M", "M", "M+*", "M+*", "M+*",
                    "M", "M", "M", "M", "M"),
            mzmed = c(408.251325886321, 426.262125882248, 427.265534374579,
                      428.268122152242, 428.268197619998, 428.2675574767,
                      428.267840674347, 429.270612779717, 429.270808224298,
                      429.269607476748, 429.270782294993, 448.243903573737,
                      464.447379285654, 504.440256583885, 505.443684675365),
            mzmin = c(408.251325886321, 426.261908233279, 427.265397484755,
                      428.267772595199, 428.267855601901, 428.2675574767,
                      428.267840674347, 429.270339913969, 429.270423563444,
                      429.269607476748, 429.270782294993, 448.243644005027,
                      464.447304014051, 504.440032161331, 505.443534603),
            mzmax = c(408.251325886321, 426.262343531217, 427.265671264404,
                      428.268471709284, 428.268539638095, 428.2675574767,
                      428.267840674347, 429.270885645465, 429.271192885151,
                      429.269607476748, 429.270782294993, 448.244163142448,
                      464.447454557257, 504.44048100644, 505.44383474773),
            rtmed = c(286.278, 286.8085, 286.8085, 279.141, 259.046, 297.915,
                      308.494, 258.782, 279.141, 296.857, 306.904, 286.8085,
                      197.973, 197.7085, 197.444),
            rtmin = c(286.278, 286.807, 286.807, 278.875, 258.782, 297.915,
                      308.494, 258.782, 278.875, 296.857, 306.904, 286.807,
                      197.973, 197.444, 197.444),
            rtmax = c(286.278, 286.81, 286.81, 279.407, 259.31, 297.915,
                      308.494, 258.782, 279.407, 296.857, 306.904, 286.81,
                      197.973, 197.973, 197.444),
            npeaks = c(1, 2, 2, 2, 2, 1, 1, 2, 2, 1, 1, 2, 2, 2, 2),
            `220221CCM_global_POS_01_ssleu_filtered` = c(NA, 6, 4, 7, 8, 12, 13,
                 10, 9, 11, NA, 5, 1, 2, 3),
            `220221CCM_global_POS_02_ssleu_filtered` = c(18, 21, 20, 22, 23, NA,
                 NA, 17, 24, NA, 25, 19, 15, 16, 14),
            check.names = FALSE
        ),
        peaks = as.data.frame(matrix(
            c(464.447304014051, 504.440032161331, 505.443534603,
              427.265397484755, 448.243644005027, 426.261908233279,
              428.267772595199, 428.267855601901, 429.270423563444,
              429.270339913969, 429.269607476748, 428.2675574767,
              428.267840674347, 505.44383474773, 464.447454557257,
              504.44048100644, 429.270885645465, 408.251325886321,
              448.244163142448, 427.265671264404, 426.262343531217,
              428.268471709284, 428.268539638095, 429.271192885151,
              429.270782294993, 464.447021484375, 504.439697265625,
              505.443084716797, 427.264739990234, 448.243011474609,
              426.261444091797, 428.267364501953, 428.267425537109,
              429.269836425781, 429.269653320312, 429.269256591797,
              428.267242431641, 428.267364501953, 505.440704345703,
              464.446746826172, 504.439544677734, 429.270324707031,
              408.251037597656, 448.242279052734, 427.264801025391,
              426.262023925781, 428.268035888672, 428.267822265625,
              429.270721435547, 429.270416259766, 464.447662353516,
              504.440490722656, 505.443664550781, 427.266052246094,
              448.245391845703, 426.262420654297, 428.268310546875,
              428.268615722656, 429.271362304688, 429.270904541016,
              429.269958496094, 428.268035888672, 428.2685546875,
              505.444122314453, 464.447967529297, 504.441101074219,
              429.271575927734, 408.25146484375, 448.245422363281,
              427.266052246094, 426.262786865234, 428.269195556641,
              428.269287109375, 429.271636962891, 429.271636962891, 197.973,
              197.444, 197.444, 286.81, 286.81, 286.81, 279.407, 258.782,
              279.407, 258.782, 296.857, 297.915, 308.494, 197.444, 197.973,
              197.973, 258.782, 286.278, 286.807, 286.807, 286.807, 278.875,
              259.31, 278.875, 306.904, 196.386, 193.743, 196.386, 284.695,
              285.224, 284.695, 265.656, 250.85, 265.656, 250.85, 295.271,
              293.684, 304.789, 196.387, 195.858, 182.11, 250.85, 284.692,
              280.99, 283.105, 284.692, 265.656, 250.85, 265.127, 301.084,
              200.617, 199.03, 199.03, 291.04, 291.04, 291.04, 293.156, 264.598,
              294.742, 264.598, 307.966, 303.202, 310.081, 201.145, 199.559,
              208.548, 264.069, 287.864, 292.095, 292.623, 293.152, 291.037,
              264.598, 291.037, 309.549, 4945601.93026269, 1287181.56877954,
              401071.227087501, 1170639.95871094, 260064.992761365,
              6139220.0505469, 21634957.3317308, 7556081.77126924,
              5360632.29847273, 1854836.50349039, 450077.636764323,
              2235868.3566111, 753309.518850004, 444013.097852865,
              5689144.27927454, 1458245.19191226, 1621835.871345,
              88824.635233072, 288524.169413714, 1186664.89020643,
              6234084.85605467, 19992518.2568646, 7375409.9176154,
              4939357.04715561, 323001.699462891, 4945487.79875439,
              1287161.27013964, 401069.111887501, 1170297.42409805,
              251531.954604928, 6137759.54643873, 20459048.501706,
              6979304.74283053, 5183447.80457555, 1771087.19378474,
              359253.245444391, 1369338.9068287, 436642.365357695,
              443940.884671369, 5689141.10698883, 1458054.42380843,
              1621823.181105, 88821.9918997387, 288157.380699577,
              1185672.72711171, 6233652.48268746, 18599650.9700816,
              6636339.71966301, 4303464.43650285, 210066.951190656, 4130684,
              1395886, 434808.75, 676902.5, 183977.625, 3501824, 1096165,
              647081.5, 266683.75, 158095.875, 90547.25, 387221, 271995.5,
              524308, 5734716, 1723138, 150635.375, 70041.5625, 186253.875,
              673140, 3489368, 1078367, 654868, 260907.75, 68280.5, 9148, 24876,
              434808, 2254, 2, 3876, 10, 6, 13, 8, 2, 1, 1, 4708, 5734715,
              14733, 150634, 70041, 719, 1279, 10826, 10, 6, 6, 1, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
              NA, 1, 2, 3, 4, 5, 6, 7, 7, 8, 8, 9, 10, 13, 1, 2, 3, 4, 5, 6, 7,
              8, 9, 9, 10, 14, 1, 2, 1, 2, 4, 1, 1, 1, 0, 0, 1, 1, 3, 7, 2, 3,
              1, 1, 2, 1, 1, 0, 1, 1, 3, 4, 4, 4, 4, 6, 4, 10, 14, 10, 14, 12,
              4, 4, 4, 14, 18, 14, 4, 6, 6, 6, 10, 14, 10, 6, 68, 67, 67, 236,
              236, 236, 222, 183, 222, 183, 255, 257, 277, 67, 68, 68, 183, 235,
              236, 236, 236, 221, 184, 221, 274, 64, 63, 63, 232, 230, 232, 212,
              169, 212, 169, 243, 253, 273, 63, 54, 50, 169, 231, 230, 230, 230,
              211, 170, 211, 268, 72, 71, 71, 240, 242, 240, 232, 197, 232, 197,
              267, 261, 281, 71, 82, 86, 197, 239, 242, 242, 242, 231, 198, 231,
              280, 65, 60, 65, 108, 104, 108, 136, 108, 136, 108, 108, 104, 103,
              65, 64, 38, 108, 108, 101, 105, 108, 136, 108, 110, 100, 73, 70,
              70, 120, 115, 120, 188, 134, 191, 134, 132, 122, 113, 74, 71, 88,
              133, 114, 122, 123, 124, 184, 134, 159, 116, 1, 1, 1, 1, 1, 1, 1,
              1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2),
            nrow = 25, ncol = 23, dimnames = list(
                c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                       "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                       "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                       "lmax", "sample")
            )
        ))
    )
    db <- db_connect(":memory:")
    db_record_xsf(db, xsf)
    testthat::expect_identical(
        db_read_table(db, "ann"),
        xsf$ann
    )
    testthat::expect_equal(
        db_read_table(db, "spectra_infos"),
        xsf$spectra_infos
    )
    testthat::expect_identical(
        db_read_table(db, "spectras"),
        xsf$spectras
    )
    testthat::expect_identical(
        db_read_table(db, "peakgroups"),
        xsf$peakgroups
    )
    testthat::expect_identical(
        db_read_table(db, "peaks"),
        xsf$peaks
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("record params", {
    cwt_params <- xcms::CentWaveParam(
        ppm = 30,
        peakwidth = c(4, 39),
        snthresh = 6.5,
        prefilter = c(2, 815),
        mzCenterFun = "wMean",
        integrate = 1,
        mzdiff = .041,
        fitgauss = FALSE,
        noise = 0,
        verboseColumns = TRUE,
        firstBaselineCheck = FALSE
    )
    obw_params <- xcms::ObiwarpParam(
        binSize = .1,
        centerSample = integer(),
        response = 1L,
        distFun = "cor_opt",
        gapInit = .3,
        gapExtend = 2.4,
        factorDiag = 2,
        factorGap = 1,
        localAlignment = FALSE,
        initPenalty = 0
    )
    pd_params <- xcms::PeakDensityParam(
        sampleGroups = seq(2),
        bw = 5,
        minFraction = 10**-9,
        minSamples = 1,
        binSize = 0.01,
        maxFeatures = 500
    )
    ann_params <- AnnotationParam(
        da_tol = .015,
        rt_tol = 10,
        abd_tol = 25,
        instrument = "QTOF_XevoG2-S_R25000@200",
        database = "test",
        cpd_classes = c("LPC", "Cer", "FA")
    )
    camera_params <- CameraParam(
        ann_param = ann_params,
        cores = 1,
        sigma = 6,
        perfwhm = .6,
        cor_eic_th = .75,
        pval = .05,
        graph_method = "hcs"
    )
    filter_params <- FilterParam(cwt_params, ann_params)

    db <- db_connect(":memory:")
    db_record_params(
        db,
        filter_params,
        cwt_params,
        obw_params,
        pd_params,
        camera_params,
        ann_params
    )
    testthat::expect_identical(
        db_read_table(db, "filter_params"),
        params_to_dataframe(filter_params)
    )
    testthat::expect_equal(
        db_read_table(db, "cwt_params"),
        params_to_dataframe(cwt_params)
    )
    testthat::expect_equal(
        db_read_table(db, "obw_params"),
        params_to_dataframe(obw_params)
    )
    testthat::expect_identical(
        db_read_table(db, "pd_params"),
        params_to_dataframe(pd_params)
    )
    testthat::expect_equal(
        db_read_table(db, "camera_params"),
        params_to_dataframe(camera_params)
    )
    testthat::expect_identical(
        db_read_table(db, "ann_params"),
        params_to_dataframe(ann_params)
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get annotations", {
    ann <- data.frame(
        pcgroup_id = c(1, 2, 3, 3, 3, 3, 3, 3, 4, 4, 5, 6, 7, 8),
        basepeak_group_id = c(4, 5, 1, 1, 2, 2, 12, 12, 13, 14, 6, 7, 15, 11),
        formula = c(NA, NA, "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C30H59N1O3", "C30H59N1O3", NA, NA, NA, NA),
        class = c(NA, NA, "LPC", "LPC", "LPC", "LPC", "LPC", "LPC", "Cer",
                  "Cer", NA, NA, NA, NA),
        name = c(NA, NA, "LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0",
                 "LPC 11:0", "LPC 11a:0", "Cer (d18:1/C12:0)",
                 "Cer (d18:1/C12:0)", NA, NA, NA, NA),
        referent_adduct = c(NA, NA, "[M+H]+", "[M+H]+", "[M+H]+", "[M+H]+",
                         "[M+H]+", "[M+H]+", "[M+H-H2O]+", "[M+H-H2O]+", NA, NA,
                         NA, NA),
        adduct = c(NA, NA, "[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+",
                   "[M+Na]+", "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", NA, NA, NA,
                   NA),
        ion_formula = c(NA, NA, "C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                        "C19H41N1O7P1", "C19H40N1O7P1Na1", "C19H40N1O7P1Na1",
                        "C30H58N1O2", "C30H59N1O3Na1", NA, NA, NA, NA),
        rtdiff = c(NA, NA, 8.99149999999997, 4.19150000000002, 8.99149999999997,
                   4.19150000000002, 8.99149999999997, 4.19150000000002,
                   2.37300000000002, 2.37300000000002, NA, NA, NA, NA),
        rt = c(279.141, 259.046, 286.8085, 286.8085, 286.8085, 286.8085,
               286.8085, 286.8085, 197.973, 197.973, 297.915, 308.494, 197.444,
               306.904),
        rtmin = c(291.037, 264.598, 287.864, 287.864, 293.152, 293.152, 292.095,
                  292.095, 199.559, 208.548, 303.202, 310.081, 201.145,
                  309.549),
        rtmax = c(279.407, 259.31, 286.81, 286.81, 286.81, 286.81, 286.81,
                  286.81, 197.973, 197.973, 297.915, 308.494, 197.444, 306.904),
        nsamples = c(2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0),
        best_score = c(0, 0, 79.8211975097656, 79.8211975097656,
                       95.0912628173828, 95.0912628173828, 79.6432037353516,
                       79.6432037353516, 71.3979721069336, 71.1946487426758, 0,
                       0, 0, 0),
        best_deviation_mz = c(Inf, Inf, .0003662109375, .0003662109375,
                              .00048828125, .00048828125, .00018310546875,
                              .00018310546875, .0010986328125, .001312255859375,
                              Inf, Inf, Inf, Inf),
        best_npeak = c(0, 0, 1, 1, 2, 2, 1, 1, 1, 1, 0, 0, 0, 0),
        `220221CCM_global_POS_01_ssleu_filtered` = c(1, 3, NA, NA, 6, 6, 8, 8,
                                                     10, 12, 14, 15, 16, NA),
        `220221CCM_global_POS_02_ssleu_filtered` = c(2, 4, 5, 5, 7, 7, 9, 9, 11,
                                                     13, NA, NA, 17, 18),
        check.names = FALSE
    )
    db <- db_connect(":memory:")
    db_write_table(db, "ann", ann)

    # 1st test : get all annotations
    testthat::expect_identical(
        db_get_annotations(db),
        ann
    )

    # 2nd test : get all annotations for a compound name
    testthat::expect_identical(
        db_get_annotations(db, names = "Cer (d18:1/C12:0)"),
        data.frame(ann[which(ann$name == "Cer (d18:1/C12:0)"), ],
                   row.names = NULL, check.names = FALSE)
    )

    # 3rd test : get all annotations for a group id
    testthat::expect_identical(
        db_get_annotations(db, pcgroup_ids = 11),
        ann[ann$pcgroup_id == 11, ]
    )

    # 4th test : get all annotations for a row ID
    testthat::expect_identical(
        db_get_annotations(db, row_ids = 3),
        data.frame(ann[3, ], row.names = NULL, check.names = FALSE)
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get spectra infos", {
    spectra_infos <- data.frame(
        spectra_id =  c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
                        17, 18),
        score = c(0, 0, 0, 0, 79.8211975097656, 95.0912628173828,
                  95.0683822631836, 79.6432037353516, 79.6432037353516,
                  71.3979721069336, 71.3979721069336, 71.1946487426758,
                  71.1946487426758, 0, 0, 0, 0, 0),
        deviation_mz = c(NaN, NaN, NaN, NaN, .0003662109375, .00048828125,
                         .0008392333984375, .00018310546875, .000701904296875,
                         .0010986328125, .001251220703125, .001312255859375,
                         .00177001953125, NaN, NaN, NaN, NaN, NaN),
        npeak = c(0, 0, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0),
        basepeak_mz = c(428.267772595199, 428.268471709284, 428.267855601901,
                        428.268539638095, 408.251325886322, 426.261908233279,
                        426.262343531217, 448.243644005027, 448.244163142448,
                        464.447304014051, 464.447454557257, 504.440032161331,
                        504.44048100644, 428.2675574767, 428.267840674347,
                        505.443534603, 505.44383474773, 429.270782294993),
        basepeak_int = c(21634957.3317308, 19992518.2568646, 7556081.77126924,
                         7375409.9176154, 88824.635233072, 6139220.0505469,
                         6234084.85605467, 260064.992761365, 288524.169413714,
                         4945601.93026269, 5689144.27927454, 1287181.56877954,
                         1458245.19191226, 2235868.3566111, 753309.518850004,
                         401071.227087501, 444013.097852865, 323001.699462891),
        sum_int = c(0, 0, 0, 0, 88824.635233072, 7309860.00925784,
                    7420749.7462611, 260064.992761365, 288524.169413714,
                    4945601.93026269, 5689144.27927454, 1287181.56877954,
                    1458245.19191226, 0, 0, 0, 0, 0),
        sample = c("220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered"),
        rt  = c(279.407, 278.875, 258.782, 259.31, 286.278, 286.81, 286.807,
                286.81, 286.807, 197.973, 197.973, 197.444, 197.973, 297.915,
                308.494, 197.444, 197.444, 306.904)
    )
    db <- db_connect(":memory:")
    db_write_table(db, "spectra_infos", spectra_infos)
    testthat::expect_equal(
        db_get_spectra_infos(db, c(1, 2)),
        spectra_infos[spectra_infos$spectra_id %in% 1:2, ]
    )
    testthat::expect_equal(
        db_get_spectra_infos(db),
        spectra_infos
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get spectras", {
    spectras <- data.frame(
        spectra_id = c(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7,
                       7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, 11, 11,
                       11, 12, 12, 12, 12, 13, 13, 13, 13, 14, 14, 15, 16, 17,
                       18),
        feature_id = c(7, 9, 22, 24, 8, 10, 23, 17, 18, NA, NA, NA, 6, 4, NA,
                       NA, 21, 20, NA, NA, 5, NA, NA, NA, 19, NA, NA, NA, 1, NA,
                       NA, NA, 15, NA, NA, NA, 2, NA, NA, NA, 16, NA, NA, NA,
                       12, 11, 13, 3, 14, 25),
        mz = c(428.267772595199, 429.270423563444, 428.268471709284,
               429.271192885151, 428.267855601901, 429.270339913969,
               428.268539638095, 429.270885645465, 408.251325886321, NA, NA, NA,
               426.261908233279, 427.265397484755, NA, NA, 426.262343531217,
               427.265671264404, NA, NA, 448.243644005027, NA, NA, NA,
               448.244163142448, NA, NA, NA, 464.447304014051, NA, NA, NA,
               464.447454557257, NA, NA, NA, 504.440032161331, NA, NA, NA,
               504.44048100644, NA, NA, NA, 428.2675574767, 429.269607476748,
               428.267840674347, 505.443534603, 505.44383474773,
               429.270782294993),
        mzmin = c(428.267364501953, 429.269836425781, 428.268035888672,
                  429.270721435547, 428.267425537109, 429.269653320312,
                  428.267822265625, 429.270324707031, 408.251037597656, NA, NA,
                  NA, 426.261444091797, 427.264739990234, NA, NA,
                  426.262023925781, 427.264801025391, NA, NA, 448.243011474609,
                  NA, NA, NA, 448.242279052734, NA, NA, NA, 464.447021484375,
                  NA, NA, NA, 464.446746826172, NA, NA, NA, 504.439697265625,
                  NA, NA, NA, 504.439544677734, NA, NA, NA, 428.267242431641,
                  429.269256591797, 428.267364501953, 505.443084716797,
                  505.440704345703, 429.270416259766),
        mzmax = c(428.268310546875, 429.271362304688, 428.269195556641,
                  429.271636962891, 428.268615722656, 429.270904541016,
                  428.269287109375, 429.271575927734, 408.25146484375, NA, NA,
                  NA, 426.262420654297, 427.266052246094, NA, NA,
                  426.262786865234, 427.266052246094, NA, NA, 448.245391845703,
                  NA, NA, NA, 448.245422363281, NA, NA, NA, 464.447662353516,
                  NA, NA, NA, 464.447967529297, NA, NA, NA, 504.440490722656,
                  NA, NA, NA, 504.441101074219, NA, NA, NA, 428.268035888672,
                  429.269958496094, 428.2685546875, 505.443664550781,
                  505.444122314453, 429.271636962891),
        rt = c(279.407, 279.407, 278.875, 278.875, 258.782, 258.782, 259.31,
               258.782, 286.278, NA, NA, NA, 286.81, 286.81, NA, NA, 286.807,
               286.807, NA, NA, 286.81, NA, NA, NA, 286.807, NA, NA, NA,
               197.973, NA, NA, NA, 197.973, NA, NA, NA, 197.444, NA, NA, NA,
               197.973, NA, NA, NA, 297.915, 296.857, 308.494, 197.444, 197.444,
               306.904),
        rtmin = c(265.656, 265.656, 265.656, 265.127, 250.85, 250.85, 250.85,
                  250.85, 284.692, NA, NA, NA, 284.695, 284.695, NA, NA,
                  284.692, 283.105, NA, NA, 285.224, NA, NA, NA, 280.99, NA, NA,
                  NA, 196.386, NA, NA, NA, 195.858, NA, NA, NA, 193.743, NA, NA,
                  NA, 182.11, NA, NA, NA, 293.684, 295.271, 304.789, 196.386,
                  196.387, 301.084),
        rtmax = c(293.156, 294.742, 291.037, 291.037, 264.598, 264.598, 264.598,
                  264.069, 287.864, NA, NA, NA, 291.04, 291.04, NA, NA, 293.152,
                  292.623, NA, NA, 291.04, NA, NA, NA, 292.095, NA, NA, NA,
                  200.617, NA, NA, NA, 199.559, NA, NA, NA, 199.03, NA, NA, NA,
                  208.548, NA, NA, NA, 303.202, 307.966, 310.081, 199.03,
                  201.145, 309.549),
        int = c(21634957.3317308, 5360632.29847273, 19992518.2568646,
                4939357.04715561, 7556081.77126924, 1854836.50349039,
                7375409.9176154, 1621835.871345, 88824.635233072, NA, NA, NA,
                6139220.0505469, 1170639.95871094, NA, NA, 6234084.85605467,
                1186664.89020643, NA, NA, 260064.992761365, NA, NA, NA,
                288524.169413714, NA, NA, NA, 4945601.93026269, NA, NA, NA,
                5689144.27927454, NA, NA, NA, 1287181.56877954, NA, NA, NA,
                1458245.19191226, NA, NA, NA, 2235868.3566111, 450077.636764323,
                753309.518850004, 401071.227087501, 444013.097852865,
                323001.699462891),
        abd = c(100, 24.7776421107639, 100, 24.7060274433394, 100,
                24.5475970170559, 100, 21.9897726290631, 100, NA, NA, NA, 100,
                19.0682195632759, NA, NA, 100, 19.0351096850072, NA, NA, 100,
                NA, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA, 100, NA, NA, NA,
                100, NA, NA, NA, 100, NA, NA, NA, 100, 20.1298808775354, 100,
                100, 100, 100),
        mz_theo = c(NA, NA, NA, NA, NA, NA, NA, NA, 408.25095, 409.25427,
                    410.25672, 411.25935, 426.26152, 427.26484, 428.26719,
                    429.26984, 426.26152, 427.26484, 428.26719, 429.26984,
                    448.24346, 449.24678, 450.24914, 451.25178, 448.24346,
                    449.24678, 450.24914, 451.25178, 464.44621, 465.44955,
                    466.45272, 467.45576, 464.44621, 465.44955, 466.45272,
                    467.45576, 504.43872, 505.44206, 506.44516, 507.44809,
                    504.43872, 505.44206, 506.44516, 507.44809, NA, NA, NA, NA,
                    NA, NA),
        abd_theo = c(NA, NA, NA, NA, NA, NA, NA, NA, 100, 21.65, 3.25, 0.38,
                     100, 21.7, 3.46, 0.42, 100, 21.7, 3.46, 0.42, 100, 21.69,
                     3.45, 0.42, 100, 21.69, 3.45, 0.42, 100, 33.55, 5.86, 0.65,
                     100, 33.55, 5.86, 0.65, 100, 33.67, 6.07, 0.72, 100, 33.67,
                     6.07, 0.72, NA, NA, NA, NA, NA, NA),
        iso_theo = c(NA, NA, NA, NA, NA, NA, NA, NA, "M", "M+1", "M+2", "M+3",
                     "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M",
                     "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1",
                     "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M", "M+1", "M+2",
                     "M+3", "M", "M+1", "M+2", "M+3", NA, NA, NA, NA, NA, NA)
    )
    db <- db_connect(":memory:")
    db_write_table(db, "spectras", spectras)
    testthat::expect_identical(
        db_get_spectras(db, c(1, 2)),
        spectras[spectras$spectra_id %in% c(1, 2), ]
    )
    testthat::expect_identical(
        db_get_spectras(db),
        spectras
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get peakgroups", {
    peakgroups <- data.frame(
        group_id = 1:15,
        pcgroup_id = c(3, 3, 3, 1, 2, 5, 6, 2, 1, 5, 8, 3, 4, 4, 7),
        adduct = c("[M+H-H2O]+", "[M+H]+", NA, NA, NA, NA, NA, NA, NA, NA, NA,
                   "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", NA),
        cluster_id = c(1, 2, 2, 4, 5, 6, 7, 5, 4, 6, 11, 12, 13, 14, 15),
        iso = c("M", "M", "M+*", "M", "M", "M", "M", "M+*", "M+*", "M+*", "M",
                "M", "M", "M", "M"),
        mzmed = c(408.251325886321, 426.262125882248, 427.265534374579,
                  428.268122152242, 428.268197619998, 428.2675574767,
                  428.267840674347, 429.270612779717, 429.270808224298,
                  429.269607476748, 429.270782294993, 448.243903573737,
                  464.447379285654, 504.440256583885, 505.443684675365),
        mzmin = c(408.251325886321, 426.261908233279, 427.265397484755,
                  428.267772595199, 428.267855601901, 428.2675574767,
                  428.267840674347, 429.270339913969, 429.270423563444,
                  429.269607476748, 429.270782294993, 448.243644005027,
                  464.447304014051, 504.440032161331, 505.443534603),
        mzmax = c(408.251325886321, 426.262343531217, 427.265671264404,
                  428.268471709284, 428.268539638095, 428.2675574767,
                  428.267840674347, 429.270885645465, 429.271192885151,
                  429.269607476748, 429.270782294993, 448.244163142448,
                  464.447454557257, 504.44048100644, 505.44383474773),
        rtmed = c(286.278, 286.8085, 286.8085, 279.141, 259.046, 297.915,
                  308.494, 258.782, 279.141, 296.857, 306.904, 286.8085,
                  197.973, 197.7085, 197.444),
        rtmin = c(286.278, 286.807, 286.807, 278.875, 258.782, 297.915, 308.494,
                  258.782, 278.875, 296.857, 306.904, 286.807, 197.973, 197.444,
                  197.444),
        rtmax = c(286.278, 286.81, 286.81, 279.407, 259.31, 297.915, 308.494,
                  258.782, 279.407, 296.857, 306.904, 286.81, 197.973, 197.973,
                  197.444),
        npeaks = c(1, 2, 2, 2, 2, 1, 1, 2, 2, 1, 1, 2, 2, 2, 2),
        `220221CCM_global_POS_01_ssleu_filtered` = c(NA, 6, 4, 7, 8, 12, 13, 10,
                                                     9, 11, NA, 5, 1, 2, 3),
        `220221CCM_global_POS_02_ssleu_filtered` = c(18, 21, 20, 22, 23, NA, NA,
                                                     17, 24, NA, 25, 19, 15, 16,
                                                     14),
        check.names = FALSE
    )
    db <- db_connect(":memory:")
    db_write_table(db, "peakgroups", peakgroups)
    testthat::expect_identical(
        db_get_peakgroups(db),
        peakgroups
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get params", {
    cwt_params <- xcms::CentWaveParam(
        ppm = 30,
        peakwidth = c(4, 39),
        snthresh = 6.5,
        prefilter = c(2, 815),
        mzCenterFun = "wMean",
        integrate = 1,
        mzdiff = .041,
        fitgauss = FALSE,
        noise = 0,
        verboseColumns = TRUE,
        firstBaselineCheck = FALSE
    )
    obw_params <- xcms::ObiwarpParam(
        binSize = .1,
        centerSample = integer(),
        response = 1L,
        distFun = "cor_opt",
        gapInit = .3,
        gapExtend = 2.4,
        factorDiag = 2,
        factorGap = 1,
        localAlignment = FALSE,
        initPenalty = 0
    )
    pd_params <- xcms::PeakDensityParam(
        sampleGroups = seq(2),
        bw = 5,
        minFraction = 10**-9,
        minSamples = 1,
        binSize = 0.01,
        maxFeatures = 500
    )
    ann_params <- AnnotationParam(
        da_tol = .015,
        rt_tol = 10,
        abd_tol = 25,
        instrument = "QTOF_XevoG2-S_R25000@200",
        database = "test",
        cpd_classes = c("LPC", "Cer", "FA")
    )
    camera_params <- CameraParam(
        ann_param = ann_params,
        cores = 1,
        sigma = 6,
        perfwhm = .6,
        cor_eic_th = .75,
        pval = .05,
        graph_method = "hcs"
    )
    filter_params <- FilterParam(cwt_params, ann_params)
    db <- db_connect(":memory:")
    db_record_params(
        db,
        filter_params,
        cwt_params,
        obw_params,
        pd_params,
        camera_params,
        ann_params
    )
    testthat::expect_identical(
        db_get_params(db),
        list(
            filter = params_to_dataframe(filter_params),
            cwt = params_to_dataframe(cwt_params),
            obw = params_to_dataframe(obw_params),
            pd = params_to_dataframe(pd_params),
            camera = params_to_dataframe(camera_params),
            ann = params_to_dataframe(ann_params)
        )
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("count number of samples", {
    db <- db_connect(":memory:")

    # 1st test : test with no samples
    testthat::expect_identical(
        db_get_nsamples(db),
        0
    )

    # 2nd test : normal test
    spectra_infos <- data.frame(
        spectra_id =  c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
                        17, 18),
        score = c(0, 0, 0, 0, 79.8211975097656, 95.0912628173828,
                  95.0683822631836, 79.6432037353516, 79.6432037353516,
                  71.3979721069336, 71.3979721069336, 71.1946487426758,
                  71.1946487426758, 0, 0, 0, 0, 0),
        deviation_mz = c(NaN, NaN, NaN, NaN, .0003662109375, .00048828125,
                         .0008392333984375, .00018310546875, .000701904296875,
                         .0010986328125, .001251220703125, .001312255859375,
                         .00177001953125, NaN, NaN, NaN, NaN, NaN),
        npeak = c(0, 0, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0),
        basepeak_mz = c(428.267772595199, 428.268471709284, 428.267855601901,
                        428.268539638095, 408.251325886322, 426.261908233279,
                        426.262343531217, 448.243644005027, 448.244163142448,
                        464.447304014051, 464.447454557257, 504.440032161331,
                        504.44048100644, 428.2675574767, 428.267840674347,
                        505.443534603, 505.44383474773, 429.270782294993),
        basepeak_int = c(21634957.3317308, 19992518.2568646, 7556081.77126924,
                         7375409.9176154, 88824.635233072, 6139220.0505469,
                         6234084.85605467, 260064.992761365, 288524.169413714,
                         4945601.93026269, 5689144.27927454, 1287181.56877954,
                         1458245.19191226, 2235868.3566111, 753309.518850004,
                         401071.227087501, 444013.097852865, 323001.699462891),
        sum_int = c(0, 0, 0, 0, 88824.635233072, 7309860.00925784,
                    7420749.7462611, 260064.992761365, 288524.169413714,
                    4945601.93026269, 5689144.27927454, 1287181.56877954,
                    1458245.19191226, 0, 0, 0, 0, 0),
        sample = c("220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered"),
        rt  = c(279.407, 278.875, 258.782, 259.31, 286.278, 286.81, 286.807,
                286.81, 286.807, 197.973, 197.973, 197.444, 197.973, 297.915,
                308.494, 197.444, 197.444, 306.904)
    )
    db_write_table(db, "spectra_infos", spectra_infos)
    testthat::expect_identical(
        db_get_nsamples(db),
        2
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("resolve conflict", {
    ann <- data.frame(
        pcgroup_id = c(1, 2, 3, 3, 3, 3, 3, 3, 4, 4, 5, 6, 7, 8),
        basepeak_group_id = c(4, 5, 1, 1, 2, 2, 12, 12, 13, 14, 6, 7, 15, 11),
        formula = c(NA, NA, "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C30H59N1O3", "C30H59N1O3", NA, NA, NA, NA),
        class = c(NA, NA, "LPC", "LPC", "LPC", "LPC", "LPC", "LPC", "Cer",
                  "Cer", NA, NA, NA, NA),
        name = c(NA, NA, "LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0",
                 "LPC 11:0", "LPC 11a:0", "Cer (d18:1/C12:0)",
                 "Cer (d18:1/C12:0)", NA, NA, NA, NA),
        referent_adduct = c(NA, NA, "[M+H]+", "[M+H]+", "[M+H]+", "[M+H]+",
                            "[M+H]+", "[M+H]+", "[M+H-H2O]+", "[M+H-H2O]+", NA,
                            NA, NA, NA),
        adduct = c(NA, NA, "[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+",
                   "[M+Na]+", "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", NA, NA, NA,
                   NA),
        ion_formula = c(NA, NA, "C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                        "C19H41N1O7P1", "C19H40N1O7P1Na1", "C19H40N1O7P1Na1",
                        "C30H58N1O2", "C30H59N1O3Na1", NA, NA, NA, NA),
        rtdiff = c(NA, NA, 8.99149999999997, 4.19150000000002, 8.99149999999997,
                   4.19150000000002, 8.99149999999997, 4.19150000000002,
                   2.37300000000002, 2.37300000000002, NA, NA, NA, NA),
        rt = c(279.141, 259.046, 286.8085, 286.8085, 286.8085, 286.8085,
               286.8085, 286.8085, 197.973, 197.973, 297.915, 308.494, 197.444,
               306.904),
        rtmin = c(265.656, 250.85, 284.692, 284.692, 284.692, 284.692, 280.99,
                  280.99, 195.858, 182.11, 293.684, 304.789, 196.386, 301.084),
        rtmax = c(293.156, 264.598, 287.864, 287.864, 293.152, 293.152, 292.095,
                  292.095, 200.617, 208.548, 303.202, 310.081, 201.145,
                  309.549),
        nsamples = c(2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0),
        best_score = c(0, 0, 79.8211975097656, 79.8211975097656,
                       95.0912628173828, 95.0912628173828, 79.6432037353516,
                       79.6432037353516, 71.3979721069336, 71.1946487426758, 0,
                       0, 0, 0),
        best_deviation_mz = c(NA, NA, .0003662109375, .0003662109375,
                              .00048828125, .00048828125, .00018310546875,
                              .00018310546875, .0010986328125, .001312255859375,
                              NA, NA, NA, NA),
        best_npeak = c(0, 0, 1, 1, 2, 2, 1, 1, 1, 1, 0, 0, 0, 0),
        `220221CCM_global_POS_01_ssleu_filtered` = c(1, 3, NA, NA, 6, 6, 8, 8,
                                                     10, 12, 14, 15, 16, NA),
        `220221CCM_global_POS_02_ssleu_filtered` = c(2, 4, 5, 5, 7, 7, 9, 9, 11,
                                                     13, NA, NA, 17, 18),
        check.names = FALSE
    )
    db <- db_connect(":memory:")
    db_write_table(db, "ann", ann)
    db_resolve_conflict(db, 3, "LPC 11a:0")
    ann <- data.frame(ann[-which(
        ann$pcgroup_id == 3 & ann$name != "LPC 11a:0"), ],
        row.names = NULL, check.names = FALSE)
    testthat::expect_identical(
        db_read_table(db, "ann"),
        ann
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db record EICs", {
    rts <- c(162.543, 163.072, 163.601, 164.13, 164.659, 165.187, 165.716,
             166.245, 166.774, 167.302, 167.831, 168.36, 168.889, 169.418,
             169.946, 170.475, 171.004, 171.533, 172.061, 172.59, 173.119,
             173.648, 174.177, 174.705, 175.234, 175.763, 176.292, 176.82,
             177.349, 177.878, 178.407, 178.935, 179.464, 179.993, 180.522,
             181.051, 181.579, 182.108, 182.637, 183.166, 183.695, 184.223,
             184.752, 185.281, 185.81, 186.338, 186.867, 187.396, 187.925,
             188.453, 188.982, 189.511, 190.04, 190.569, 191.097, 191.626,
             192.156, 192.685, 193.214, 193.743, 194.271, 194.8, 195.329,
             195.858, 196.386, 196.915, 197.444, 197.973, 198.502, 199.03,
             199.559, 200.088, 200.617, 201.145, 201.674, 202.203, 202.732,
             203.261, 203.789, 204.318, 204.847, 205.376, 205.904, 206.433,
             206.962, 207.491, 208.02, 208.548, 209.077, 209.606, 210.135,
             210.663, 211.192, 211.721, 212.25, 212.779, 213.307, 213.836,
             214.365, 214.894, 215.422, 215.951, 216.48, 217.009, 217.538,
             218.066, 218.595, 219.124, 219.653, 220.181, 220.71, 221.239,
             221.768, 222.296, 222.825, 223.354, 223.883, 224.412, 224.94,
             225.469, 225.998, 226.527, 227.055, 227.584, 228.113, 228.642,
             229.171, 229.699, 230.228, 230.757, 231.286, 231.814, 232.343,
             232.872, 233.401, 233.93, 234.458, 234.987, 235.516, 236.045,
             236.573, 237.102)
    eics <- data.frame(
        group_id = c(rep(13, 142), rep(14, 141)),
        rt = c(rts, rts[-length(rts)]),
        `220221CCM_global_POS_01_ssleu_filtered.mzXML` = c(NA, NA, NA, NA, NA,
           199.861572265625, NA, NA, 394.248779296875, NA, 299.23583984375, NA,
           NA, NA, 244.023681640625, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
           NA, 441.681396484375, NA, NA, NA, NA, NA, NA, 253, NA,
           243.43212890625, 341.361328125, NA, NA, NA, NA, NA, NA, NA, NA, NA,
           NA, NA, NA, NA, NA, NA, NA, NA, NA, 509.606201171875, NA, NA,
           515.10986328125, NA, NA, NA, NA, NA, 769199.5, 4056878, 4130684,
           388595.25, NA, 9644.6875, 5816.8359375, 4466.09375, NA,
           2891.658203125, NA, NA, NA, NA, 458.009765625, NA, NA, NA, NA, NA,
           NA, NA, NA, 1336.8076171875, NA, NA, NA, NA, NA, NA, NA,
           422.3251953125, NA, NA, NA, NA, NA, NA, 752.5478515625, NA, NA, NA,
           259.13916015625, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
           NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 237.429443359375, NA, NA,
           NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
           NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
           182.1103515625, NA, NA, 156.200927734375, NA, NA, 173.464599609375,
           NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 258.693115234375,
           135.357055664062, NA, NA, NA, NA, NA, NA, 186.248168945312, NA, NA,
           NA, NA, NA, NA, NA, 522.54443359375, NA, NA, NA, NA, 148792.875,
           1395886, 816974.5, 72440.25, NA, NA, NA, 638.46875, NA, NA, NA,
           466.333984375, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
           NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 555.8876953125, NA, NA,
           186.524780273438, NA, NA, NA, 284.146484375, NA, NA,
           183.346557617188, NA, NA, NA, NA, NA, 211.48828125, NA, NA,
           151.522827148438, 223.859008789062, NA, NA, NA, NA, NA,
           464.28271484375, NA, NA, 325.0712890625, NA, NA, NA, NA, NA, NA, NA,
           NA, NA, NA),
        `220221CCM_global_POS_02_ssleu_filtered.mzXML` = c(NA, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
            256.14990234375, NA, NA, NA, NA, 429.933837890625, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
            8866.2734375, 1631792, 5734716, 3129146, 224961.25, 21989.9375, NA,
            6092.8828125, NA, NA, NA, NA, NA, NA, NA, 660.07958984375, NA, NA,
            NA, 819.021484375, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 507.470947265625, NA,
            NA, 643.7119140625, NA, 242.248413085938, NA, NA, NA, NA, NA, NA,
            NA, NA, 283.0126953125, NA, NA, NA, 254.658447265625, NA, NA,
            391.944580078125, 103.657653808594, NA, 376.037353515625, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 315.4375, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
            281.672119140625, NA, 309.37060546875, NA, NA, 331.314697265625, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 353.10546875, NA, NA, NA,
            NA, NA, NA, NA, 402.763916015625, NA, NA, NA, NA, NA, NA, NA,
            130.551635742188, NA, 134.438720703125, NA, NA, NA, NA, NA, NA,
            1104.9599609375, NA, 339133.5, 1723138, 642538.5, 42233.40625,
            3690.009765625, NA, NA, NA, NA, 796.83251953125, NA,
            178.636962890625, NA, NA, NA, NA, 329.189453125, NA, NA, NA,
            490.173828125, NA, 149.362548828125, NA, 219.229248046875, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
            NA, 415.034423828125, NA, NA, 221.470703125, 488.4794921875, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, 159.431274414062, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
        check.names = FALSE
    )
    mzmat <- eics
    mzmat[, "220221CCM_global_POS_01_ssleu_filtered.mzXML"] <- c(NA, NA, NA, NA,
        NA, 464.444396972656, NA, NA, 464.444122314453, NA, 464.444366455078,
        NA, NA, NA, 464.446228027344, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, 464.444244384766, NA, NA, NA, NA, NA, NA, 464.445709228516, NA,
        464.446960449219, 464.446838378906, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, 464.447540283203, NA, NA,
        464.445831298828, NA, NA, NA, NA, NA, 464.447662353516,
        464.447021484375, 464.447509765625, 464.447357177734, NA,
        464.444641113281, 464.447601318359, 464.445831298828, NA,
        464.446166992188, NA, NA, NA, NA, 464.447631835938, NA, NA, NA, NA, NA,
        NA, NA, NA, 464.446838378906, NA, NA, NA, NA, NA, NA, NA,
        464.445526123047, NA, NA, NA, NA, NA, NA, 464.447692871094, NA, NA, NA,
        464.444732666016, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 464.445678710938, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        504.439483642578, NA, NA, 504.438415527344, NA, NA, 504.440155029297,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 504.439666748047,
        504.4404296875, NA, NA, NA, NA, NA, NA, 504.441131591797, NA, NA, NA,
        NA, NA, NA, NA, 504.440124511719, NA, NA, NA, NA, 504.440490722656,
        504.439910888672, 504.440185546875, 504.439697265625, NA, NA, NA,
        504.438720703125, NA, NA, NA, 504.440185546875, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        504.436737060547, NA, NA, 504.439605712891, NA, NA, NA,
        504.439361572266, NA, NA, 504.438415527344, NA, NA, NA, NA, NA,
        504.439025878906, NA, NA, 504.43798828125, 504.439636230469, NA, NA, NA,
        NA, NA, 504.438751220703, NA, NA, 504.441009521484, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA)
    mzmat[, "220221CCM_global_POS_02_ssleu_filtered.mzXML"] <- c(NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        464.44580078125, NA, NA, NA, NA, 464.444580078125, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        464.447875976562, 464.447937011719, 464.447418212891, 464.447235107422,
        464.447967529297, 464.446746826172, NA, 464.4482421875, NA, NA, NA, NA,
        NA, NA, NA, 464.448333740234, NA, NA, NA, 464.444183349609, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, 464.44580078125, NA, NA, 464.444519042969, NA, 464.446441650391,
        NA, NA, NA, NA, NA, NA, NA, NA, 464.444274902344, NA, NA, NA,
        464.443908691406, NA, NA, 464.446929931641, 464.446624755859, NA,
        464.447174072266, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, 504.438537597656, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, 504.439147949219, NA, 504.439666748047, NA, NA,
        504.4384765625, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        504.440399169922, NA, NA, NA, NA, NA, NA, NA, 504.4375, NA, NA, NA, NA,
        NA, NA, NA, 504.437103271484, NA, 504.436248779297, NA, NA, NA, NA, NA,
        NA, 504.441131591797, NA, 504.441040039062, 504.440490722656,
        504.440124511719, 504.441101074219, 504.439544677734, NA, NA, NA, NA,
        504.440490722656, NA, 504.440826416016, NA, NA, NA, NA, 504.44091796875,
        NA, NA, NA, 504.439544677734, NA, 504.436370849609, NA,
        504.437866210938, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA, NA, NA, NA, NA, NA, NA, 504.440155029297, NA, NA, 504.440093994141,
        504.438232421875, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        504.437103271484, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
        NA)
    xset <- readRDS(system.file("testdata", "xset.RDS", package = "SPRING"))

    tmp_file <- tempfile(fileext = ".sqlite")
    file.copy(
        system.file(
            "testdata",
            "220221CCM_global.sqlite",
            package = "SPRING"
        ),
        tmp_file,
        overwrite = TRUE
    )
    db <- db_connect(tmp_file)
    # light the database
    db_execute(db, "DELETE FROM peakgroups WHERE pcgroup_id != 4;")
    db_execute(db, "DELETE FROM eic;")
    db_execute(db, "DELETE FROM mzmat;")
    db_record_mzdata(db, xset)
    testthat::expect_equal(
        db_get_query(db, "SELECT * FROM eic"),
        eics
    )
    testthat::expect_equal(
        db_get_query(db, "SELECT * FROM mzmat"),
        mzmat
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db get eic", {
    eic <- data.frame(
        rt = c(162.543, 163.072, 163.601, 164.13, 164.659, 165.187, 165.716,
               166.245, 166.774, 167.302, 167.831, 168.36, 168.889, 169.418,
               169.946, 170.475, 171.004, 171.533, 172.061, 172.59, 173.119,
               173.648, 174.177, 174.705, 175.234, 175.763, 176.292, 176.82,
               177.349, 177.878, 178.407, 178.935, 179.464, 179.993, 180.522,
               181.051, 181.579, 182.108, 182.637, 183.166, 183.695, 184.223,
               184.752, 185.281, 185.81, 186.338, 186.867, 187.396, 187.925,
               188.453, 188.982, 189.511, 190.04, 190.569, 191.097, 191.626,
               192.156, 192.685, 193.214, 193.743, 194.271, 194.8, 195.329,
               195.858, 196.386, 196.915, 197.444, 197.973, 198.502, 199.03,
               199.559, 200.088, 200.617, 201.145, 201.674, 202.203, 202.732,
               203.261, 203.789, 204.318, 204.847, 205.376, 205.904, 206.433,
               206.962, 207.491, 208.02, 208.548, 209.077, 209.606, 210.135,
               210.663, 211.192, 211.721, 212.25, 212.779, 213.307, 213.836,
               214.365, 214.894, 215.422, 215.951, 216.48, 217.009, 217.538,
               218.066, 218.595, 219.124, 219.653, 220.181, 220.71, 221.239,
               221.768, 222.296, 222.825, 223.354, 223.883, 224.412, 224.94,
               225.469, 225.998, 226.527, 227.055, 227.584, 228.113, 228.642,
               229.171, 229.699, 230.228, 230.757, 231.286, 231.814, 232.343,
               232.872, 233.401, 233.93, 234.458, 234.987, 235.516, 236.045,
               236.573, 237.102),
        `220221CCM_global_POS_01_ssleu_filtered.mzXML` = c(0, 0, 0, 0, 0,
           199.861572265625, 0, 0, 394.248779296875, 0, 299.23583984375, 0, 0,
           0, 244.023681640625, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
           441.681396484375, 0, 0, 0, 0, 0, 0, 253, 0, 243.43212890625,
           341.361328125, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
           509.606201171875, 0, 0, 515.10986328125, 0, 0, 0, 0, 0, 769199.5,
           4056878, 4130684, 388595.25, 0, 9644.6875, 5816.8359375, 4466.09375,
           0, 2891.658203125, 0, 0, 0, 0, 458.009765625, 0, 0, 0, 0, 0, 0, 0, 0,
           1336.8076171875, 0, 0, 0, 0, 0, 0, 0, 422.3251953125, 0, 0, 0, 0, 0,
           0, 752.5478515625, 0, 0, 0, 259.13916015625, 0, 0, 0, 0, 0, 0, 0, 0,
           0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 237.429443359375, 0,
           0, 0, 0, 0, 0, 0, 0, 0),
        `220221CCM_global_POS_02_ssleu_filtered.mzXML` = c(0, 0, 0, 0, 0, 0, 0,
           0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
           0, 0, 0, 0, 0, 0, 0, 256.14990234375, 0, 0, 0, 0, 429.933837890625,
           0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
           8866.2734375, 1631792, 5734716, 3129146, 224961.25, 21989.9375, 0,
           6092.8828125, 0, 0, 0, 0, 0, 0, 0, 660.07958984375, 0, 0, 0,
           819.021484375, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
           0, 0, 0, 0, 0, 507.470947265625, 0, 0, 643.7119140625, 0,
           242.248413085938, 0, 0, 0, 0, 0, 0, 0, 0, 283.0126953125, 0, 0, 0,
           254.658447265625, 0, 0, 391.944580078125, 103.657653808594, 0,
           376.037353515625, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
        check.names = FALSE
    )
    db <- db_connect(system.file(
        "testdata",
        "220221CCM_global.sqlite",
        package = "SPRING"
    ))

    testthat::expect_equal(
        db_get_eic(db, 13),
        eic
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get group ID", {
    ann <- data.frame(
        pcgroup_id = c(1, 2, 3, 3, 3, 3, 3, 3, 4, 4, 5, 6, 7, 8),
        basepeak_group_id = c(4, 5, 1, 1, 2, 2, 12, 12, 13, 14, 6, 7, 15, 11),
        formula = c(NA, NA, "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C19H40N1O7P1", "C19H40N1O7P1", "C19H40N1O7P1",
                    "C30H59N1O3", "C30H59N1O3", NA, NA, NA, NA),
        class = c(NA, NA, "LPC", "LPC", "LPC", "LPC", "LPC", "LPC", "Cer",
                  "Cer", NA, NA, NA, NA),
        name = c(NA, NA, "LPC 11:0", "LPC 11a:0", "LPC 11:0", "LPC 11a:0",
                 "LPC 11:0", "LPC 11a:0", "Cer (d18:1/C12:0)",
                 "Cer (d18:1/C12:0)", NA, NA, NA, NA),
        referent_adduct = c(NA, NA, "[M+H]+", "[M+H]+", "[M+H]+", "[M+H]+",
                            "[M+H]+", "[M+H]+", "[M+H-H2O]+", "[M+H-H2O]+", NA,
                            NA, NA, NA),
        adduct = c(NA, NA, "[M+H-H2O]+", "[M+H-H2O]+", "[M+H]+", "[M+H]+",
                   "[M+Na]+", "[M+Na]+", "[M+H-H2O]+", "[M+Na]+", NA, NA, NA,
                   NA),
        ion_formula = c(NA, NA, "C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1",
                        "C19H41N1O7P1", "C19H40N1O7P1Na1", "C19H40N1O7P1Na1",
                        "C30H58N1O2", "C30H59N1O3Na1", NA, NA, NA, NA),
        rtdiff = c(NA, NA, 8.99149999999997, 4.19150000000002, 8.99149999999997,
                   4.19150000000002, 8.99149999999997, 4.19150000000002,
                   2.37300000000002, 2.37300000000002, NA, NA, NA, NA),
        rt = c(279.141, 259.046, 286.8085, 286.8085, 286.8085, 286.8085,
               286.8085, 286.8085, 197.973, 197.973, 297.915, 308.494, 197.444,
               306.904),
        rtmin = c(265.656, 250.85, 284.692, 284.692, 284.692, 284.692, 280.99,
                  280.99, 195.858, 182.11, 293.684, 304.789, 196.386, 301.084),
        rtmax = c(293.156, 264.598, 287.864, 287.864, 293.152, 293.152, 292.095,
                  292.095, 200.617, 208.548, 303.202, 310.081, 201.145,
                  309.549),
        nsamples = c(2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0),
        best_score = c(0, 0, 79.8211975097656, 79.8211975097656,
                       95.0912628173828, 95.0912628173828, 79.6432037353516,
                       79.6432037353516, 71.3979721069336, 71.1946487426758, 0,
                       0, 0, 0),
        best_deviation_mz = c(NA, NA, .0003662109375, .0003662109375,
                              .00048828125, .00048828125, .00018310546875,
                              .00018310546875, .0010986328125, .001312255859375,
                              NA, NA, NA, NA),
        best_npeak = c(0, 0, 1, 1, 2, 2, 1, 1, 1, 1, 0, 0, 0, 0),
        `220221CCM_global_POS_01_ssleu_filtered` = c(1, 3, NA, NA, 6, 6, 8, 8,
                                                     10, 12, 14, 15, 16, NA),
        `220221CCM_global_POS_02_ssleu_filtered` = c(2, 4, 5, 5, 7, 7, 9, 9, 11,
                                                     13, NA, NA, 17, 18),
        check.names = FALSE
    )
    db <- db_connect(":memory:")
    db_write_table(db, "ann", ann)

    # 1st test: no results cause no name or row id given
    testthat::expect_equal(
        db_get_group_id(db),
        NULL
    )

    # 2nd test: with a cpd name
    testthat::expect_equal(
        db_get_group_id(db, name = "LPC 11:0"),
        2
    )

    # 3rd test: with a row ID
    testthat::expect_equal(
        db_get_group_id(db, row_id = 3),
        1
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get group IDs", {
    db <- db_connect(system.file(
        "testdata",
        "220221CCM_global.sqlite",
        package = "SPRING"
    ))
    testthat::expect_identical(
        db_get_group_ids(db, 100),
        integer(0)
    )
    testthat::expect_equal(
        db_get_group_ids(db, c(1, 2)),
        c(4, 9)
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("get max IDs", {
    db_tmp <- db_connect(":memory:")
    db <- db_connect(system.file(
        "testdata",
        "220221CCM_global.sqlite",
        package = "SPRING"
    ))
    testthat::expect_null(db_get_max_ids(db_tmp))
    testthat::expect_identical(
        db_get_max_ids(db),
        c(feature = 25, group = 15, spectra = 18, pcgroup = 8, cluster = 15)
    )
    RSQLite::dbDisconnect(db_tmp)
    RSQLite::dbDisconnect(db)
})

testthat::test_that("copy eic & m/z mat", {
    db <- db_connect(":memory:")
    rts <- c(247.149, 247.678, 248.207, 248.735, 249.264, 249.793, 250.322,
         250.85, 251.379, 251.908, 252.437, 252.965, 253.494, 254.023, 254.552,
         255.081, 255.609, 256.138, 256.667, 257.196, 257.724, 258.253, 258.782,
         259.311, 259.84, 260.368, 260.897, 261.426, 261.955, 262.483, 263.012,
         263.541, 264.07, 264.598, 265.127, 265.656, 266.185, 266.714, 267.242,
         267.771, 268.3, 268.829, 269.357, 269.886, 270.415, 270.944, 271.473,
         272.004, 272.533, 273.062, 273.591, 274.12, 274.648, 275.177, 275.706,
         276.235, 276.763, 277.292, 277.821, 278.35, 278.878, 279.407, 279.936,
         280.465, 280.994, 281.522, 282.051, 282.58, 283.109, 283.637, 284.166,
         284.695, 285.224, 285.753, 286.281, 286.81, 287.339, 287.868, 288.396,
         288.925, 289.454, 289.983, 290.512, 291.04, 291.569, 292.098, 292.627,
         293.156, 293.684, 294.213, 294.742, 295.271, 295.799, 296.328, 296.857,
         297.386, 297.915, 298.443, 298.972, 299.501, 300.03, 300.558, 301.087,
         301.616, 302.145, 302.674, 303.202, 303.731, 304.26, 304.789, 305.317,
         305.847, 306.379, 306.908, 307.437, 307.966, 308.494, 309.023, 309.552,
         310.081, 310.61, 311.138, 311.667, 312.196, 312.725, 313.253, 313.782,
         314.311, 314.84, 315.369, 315.897, 316.426, 316.955, 317.484, 318.013,
         318.541, 319.07, 319.599, 320.128, 320.657, 321.186)
    eic <- data.frame(
        group_id = rep(1, 141),
        rt = rts,
        `220221CCM_global_POS_01_ssleu_filtered.mzXML` = c(rep(0, 26),
            245.137573242188, rep(0, 5), 553.31005859375, rep(0, 7),
            146.30126953125, rep(0, 7), 221.503295898438, 612.8369140625,
            rep(0, 9), 261.576904296875, 0, 946.1162109375, 658.98828125, 0, 0,
            0, 284.175048828125, rep(0, 6), 45487.375, 76420.25, 38193.125, 0,
            0, 0, 8173.96484375, 0, 0, 0, 2323.3515625, rep(0, 4),
            402.296142578125, rep(0, 5), 440.52294921875, rep(0, 4),
            548.2548828125, rep(0, 12), 507.15234375, rep(0, 10),
            617.48681640625, rep(0, 4), 245.449096679688, 0, 335.229736328125,
            0, 0, 0, 500.802001953125, 0, 258.686279296875, rep(0, 4)),
        `220221CCM_global_POS_02_ssleu_filtered.mzXML` = c(rep(0, 11),
            347.161865234375, rep(0, 6), 578.19482421875, 351.052734375, 0, 0,
            0, 180.820922851562, 0, 215.223754882812, 0, 0, 263.38232421875,
            rep(0, 16), 253.823852539062, 0, 0, 342.826171875, rep(0, 7),
            192.362548828125, 201.947265625, rep(0, 12), 311.2109375, 0,
            3766.162109375, 46449.0625, 70041.5625, 32953.375, 14806.171875, 0,
            0, 0, 11196.484375, 0, 0, 1253.078125, rep(0, 13), 734.49609375, 0,
            0, 0, 769.12109375, 412.291015625, rep(0, 11), 662.1005859375,
            rep(0, 14), 273.28271484375, 0, 771.9072265625, 421.817138671875, 0,
            906.169921875, rep(0, 6))
    )
    mzmat <- data.frame(
        group_id = rep(1, 141),
        rt = rts,
        `220221CCM_global_POS_01_ssleu_filtered.mzXML` = c(rep(NA, 26),
            408.252532958984, rep(NA, 5), 408.252288818359, rep(NA, 7),
            408.251312255859, rep(NA, 7), 408.25244140625, 408.251647949219,
            rep(NA, 9), 408.249328613281, NA, 408.250946044922,
            408.252777099609, NA, NA, NA, 408.252410888672, rep(NA, 6),
            408.25146484375, 408.251861572266, 408.251403808594, NA, NA, NA,
            408.249877929688, NA, NA, NA, 408.252746582031, rep(NA, 4),
            408.252471923828, rep(NA, 5), 408.250610351562, rep(NA, 4),
            408.252258300781, rep(NA, 12), 408.251159667969, rep(NA, 10),
            408.249420166016, rep(NA, 4), 408.251190185547, NA,
            408.250640869141, NA, NA, NA, 408.250091552734, NA,
            408.252655029297, rep(NA, 4)),
        `220221CCM_global_POS_02_ssleu_filtered.mzXML` = c(rep(NA, 11),
            408.25244140625, rep(NA, 6), 408.249389648438, 408.251708984375, NA,
            NA, NA, 408.250732421875, NA, 408.251495361328, NA, NA,
            408.250885009766, rep(NA, 16), 408.249298095703, NA, NA,
            408.249603271484, rep(NA, 7), 408.25146484375, 408.250152587891,
            rep(NA, 12), 408.251495361328, NA, 408.251251220703,
            408.25146484375, 408.251434326172, 408.251037597656,
            408.251037597656, NA, NA, NA, 408.251617431641, NA, NA,
            408.250732421875, rep(NA, 13), 408.249755859375, NA, NA, NA,
            408.250213623047, 408.250579833984, rep(NA, 11), 408.251739501953,
            rep(NA, 14), 408.252502441406, NA, 408.248962402344,
            408.249938964844, NA, 408.250457763672, rep(NA, 6))
    )
    db_write_table(db, "eic", eic)
    db_write_table(db, "mzmat", mzmat)

    invisible(db_copy_eic_mzmat(db, colnames(eic)[3:4], 1, 2))
    testthat::expect_identical(
        db_get_eic(db, 2),
        eic[, -1]
    )
    testthat::expect_identical(
        db_get_mzmat(db, 2),
        mzmat[, -1]
    )
    RSQLite::dbDisconnect(db)
})

testthat::test_that("db replace ann", {
    ann <- data.frame(
        pcgroup_id = rep(3, 3),
        basepeak_group_id = c(1, 1, 2),
        formula = rep("C19H40N1O7P1", 3),
        class = rep("LPC", 3),
        name = rep("LPC 11:0", 3),
        referent_adduct = rep("[M+H]+", 3),
        adduct = c("[M+H-H2O]+, [M+Na]+, [M+H]+"),
        ion_formula = c("C19H39N1O6P1", "C19H39N1O6P1", "C19H41N1O7P1"),
        rtdiff = c(8.99149999999997, 4.19150000000002, 8.99149999999997),
        rt = rep(286.8085, 3),
        rtmin = c(287.864, 287.864, 293.152),
        rtmax = rep(286.81, 3),
        nsamples = rep(2, 3),
        best_score = c(79.8211975097656, 79.8211975097656, 95.0912628173828),
        best_deviation_mz = c(0.0003662109375, 0.0003662109375, 0.00048828125),
        best_npeak = c(1, 1, 2),
        `220221CCM_global_POS_01_ssleu_filtered` = c(NA, NA, 6),
        `220221CCM_global_POS_02_ssleu_filtered` = c(5, 5, 7),
        check.names = FALSE
    )
    spectra_infos <- data.frame(
        spectra_id = 5:7,
        score = c(79.8211975097656, 95.0912628173828, 95.0683822631836),
        deviation_mz = c(.0003662109375, .00048828125, .0008392333984375),
        npeak = c(1, 2, 2),
        basepeak_mz = c(408.251325886322, 426.261908233279, 426.262343531217),
        basepeak_int = c(88824.635233072, 6139220.0505469, 6234084.85605467),
        sum_int = c(88824.635233072, 7309860.00925784, 7420749.7462611),
        sample = c("220221CCM_global_POS_02_ssleu_filtered",
                   "220221CCM_global_POS_01_ssleu_filtered",
                   "220221CCM_global_POS_02_ssleu_filtered"),
        rt  = c(286.278, 286.81, 286.807)
    )
    spectras <- data.frame(
        spectra_id = c(5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7),
        feature_id = c(18, NA, NA, NA, 6, 4, NA, NA, 21, 20, NA, NA),
        mz = c(408.251325886321, NA, NA, NA, 426.261908233279, 427.265397484755,
            NA, NA, 426.262343531217, 427.265671264404, NA, NA),
        mzmin = c(408.251037597656, NA, NA, NA, 426.261444091797,
            427.264739990234, NA, NA, 426.262023925781, 427.264801025391, NA,
            NA),
        mzmax = c(408.25146484375, NA, NA, NA, 426.262420654297,
            427.266052246094, NA, NA, 426.262786865234, 427.266052246094, NA,
            NA),
        rt = c(286.278, NA, NA, NA, 286.81, 286.81, NA, NA, 286.807, 286.807,
            NA, NA),
        rtmin = c(284.692, NA, NA, NA, 284.695, 284.695, NA, NA, 284.692,
            283.105, NA, NA),
        rtmax = c(287.864, NA, NA, NA, 291.04, 291.04, NA, NA, 293.152, 292.623,
            NA, NA),
        int = c(88824.635233072, NA, NA, NA, 6139220.0505469, 1170639.95871094,
            NA, NA, 6234084.85605467, 1186664.89020643, NA, NA),
        abd = c(100, NA, NA, NA, 100, 19.0682195632759, NA, NA, 100,
            19.0351096850072, NA, NA),
        mz_theo = c(408.25095, 409.25427, 410.25672, 411.25935, 426.26152,
            427.26484, 428.26719, 429.26984, 426.26152, 427.26484, 428.26719,
            429.26984),
        abd_theo = c(100, 21.65, 3.25, 0.38, 100, 21.7, 3.46, 0.42, 100, 21.7,
            3.46, 0.42),
        iso_theo = c("M", "M+1", "M+2", "M+3", "M", "M+1", "M+2", "M+3", "M",
                     "M+1", "M+2", "M+3")
    )
    peakgroups <- data.frame(
        group_id = c(1, 2, 3, 12),
        pcgroup_id = c(3, 3, 3, 3),
        adduct = c("[M+H-H2O]+", "[M+H]+", NA, "[M+Na]+"),
        cluster_id = c(1, 2, 2, 12),
        iso = c("M", "M", "M+*", "M"),
        mzmed = c(408.251325886321, 426.262125882248, 427.265534374579,
            448.243903573737),
        mzmin = c(408.251325886321, 426.261908233279, 427.265397484755,
            448.243644005027),
        mzmax = c(408.251325886321, 426.262343531217, 427.265671264404,
            448.244163142448),
        rtmed = c(286.278, 286.8085, 286.8085, 286.8085),
        rtmin = c(286.278, 286.807, 286.807, 286.807),
        rtmax = c(286.278, 286.81, 286.81, 286.81),
        npeaks = c(1, 2, 2, 2),
        `220221CCM_global_POS_01_ssleu_filtered` = c(NA, 6, 4, 5),
        `220221CCM_global_POS_02_ssleu_filtered` = c(18, 21, 20, 19),
        check.names = FALSE
    )
    peaks <- as.data.frame(matrix(
        c(427.265397484755, 448.243644005027, 426.261908233279,
          408.251325886321, 448.244163142448, 427.265671264404,
          426.262343531217, 427.264739990234, 448.243011474609,
          426.261444091797, 408.251037597656, 448.242279052734,
          427.264801025391, 426.262023925781, 427.266052246094,
          448.245391845703, 426.262420654297, 408.25146484375,
          448.245422363281, 427.266052246094, 426.262786865234, 286.81,
          286.81, 286.81, 286.278, 286.807, 286.807, 286.807, 284.695,
          285.224, 284.695, 284.692, 280.99, 283.105, 284.692, 291.04,
          291.04, 291.04, 287.864, 292.095, 292.623, 293.152,
          1170639.95871094, 260064.992761365, 6139220.0505469,
          88824.635233072, 288524.169413714, 1186664.89020643,
          6234084.85605467, 1170297.42409805, 251531.954604928,
          6137759.54643873, 88821.9918997387, 288157.380699577,
          1185672.72711171, 6233652.48268746, 676902.5, 183977.625, 3501824,
          70041.5625, 186253.875, 673140, 3489368, 2254, 2, 3876, 70041,
          719, 1279, 10826, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,
          NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 4,
          5, 6, 5, 6, 7, 8, 2, 4, 1, 1, 2, 1, 1, 4, 6, 4, 4, 6, 6, 6, 236,
          236, 236, 235, 236, 236, 236, 232, 230, 232, 231, 230, 230, 230,
          240, 242, 240, 239, 242, 242, 242, 108, 104, 108, 108, 101, 105,
          108, 120, 115, 120, 114, 122, 123, 124, 1, 1, 1, 2, 2, 2, 2),
        nrow = 7, ncol = 23, dimnames = list(
            c(), c("mz", "mzmin", "mzmax", "rt", "rtmin", "rtmax", "into",
                   "intb", "maxo", "sn", "egauss", "mu", "sigma", "h", "f",
                   "dppm", "scale", "scpos", "scmin", "scmax", "lmin",
                   "lmax", "sample")
        )
    ))
    db <- db_connect(":memory:")
    db_record_xsf(db, list(
        ann = ann,
        spectra_infos = spectra_infos,
        spectras = spectras,
        peakgroups = peakgroups,
        peaks = peaks
    ))
    db_replace_ann(
        db,
        "LPC 11:0",
        ann,
        spectra_infos,
        spectras,
        peaks,
        peakgroups
    )
    testthat::expect_equal(
        db_read_table(db, "ann"),
        ann
    )
    testthat::expect_equal(
        db_read_table(db, "spectra_infos"),
        rbind(spectra_infos, spectra_infos)
    )
    testthat::expect_equal(
        db_read_table(db, "spectras"),
        rbind(spectras, spectras)
    )
    testthat::expect_equal(
        db_read_table(db, "peakgroups"),
        rbind(peakgroups, peakgroups)
    )
    testthat::expect_equal(
        db_read_table(db, "peaks"),
        rbind(peaks, peaks)
    )
    RSQLite::dbDisconnect(db)
})
